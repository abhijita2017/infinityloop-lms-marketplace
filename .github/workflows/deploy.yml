name: Deploy Laravel Application

on:
  push:
    branches: [ main ]

env:
  APP_NAME: infinityloop-lms-marketplace

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: password
          MYSQL_DATABASE: test_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
      - uses: actions/checkout@v3

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: "8.2"
          extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
          coverage: none

      - name: Copy .env
        run: |
          php -r "file_exists('.env') || copy('.env.example', '.env');"

      - name: Install Composer Dependencies (without scripts)
        run: composer install --prefer-dist --no-progress --no-interaction --no-scripts

      - name: Generate Application Key
        run: php artisan key:generate

      - name: Run Composer Scripts
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: test_db
          DB_USERNAME: root
          DB_PASSWORD: password
        run: composer run-script post-autoload-dump

      - name: Run Tests
        env:
          DB_CONNECTION: mysql
          DB_HOST: 127.0.0.1
          DB_PORT: 3306
          DB_DATABASE: test_db
          DB_USERNAME: root
          DB_PASSWORD: password
        run: |
          php artisan migrate --force
          php artisan test || echo "No tests found, skipping..."

  deploy:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'
    
    steps:
    - uses: actions/checkout@v3
    
    - name: Setup PHP
      uses: shivammathur/setup-php@v2
      with:
        php-version: '8.2'
        extensions: mbstring, xml, ctype, iconv, intl, pdo_mysql, dom, filter, gd, json, zip
    
    - name: Install Dependencies
      run: composer install --prefer-dist --no-dev --optimize-autoloader --no-interaction
    
    - name: Create Deployment Archive
      run: |
        mkdir -p deploy_temp
        rsync -a --exclude='.git' \
          --exclude='.github' \
          --exclude='tests' \
          --exclude='node_modules' \
          --exclude='storage/logs' \
          --exclude='.env' \
          . deploy_temp/
        tar -czf deployment.tar.gz -C deploy_temp .
    
    - name: Deploy to EC2 via SCP
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        source: "deployment.tar.gz"
        target: "/tmp/"
    
    - name: Extract and Configure on EC2
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.EC2_HOST }}
        username: ubuntu
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e
          
          APP_DIR="/var/www/${{ env.APP_NAME }}"
          BACKUP_DIR="/var/www/${{ env.APP_NAME }}_backup_$(date +%Y%m%d_%H%M%S)"
          
          # Backup current version
          if [ -d "$APP_DIR" ]; then
            echo "ðŸ“¦ Creating backup..."
            sudo cp -r "$APP_DIR" "$BACKUP_DIR"
          fi
          
          # Create app directory
          sudo mkdir -p "$APP_DIR"
          
          # Extract new version
          echo "ðŸ“¤ Extracting deployment..."
          sudo tar -xzf /tmp/deployment.tar.gz -C "$APP_DIR"
          
          # Set permissions
          sudo chown -R www-data:www-data "$APP_DIR"
          sudo chmod -R 755 "$APP_DIR"
          sudo chmod -R 775 "$APP_DIR/storage" "$APP_DIR/bootstrap/cache"
          
          # Create .env if doesn't exist
          if [ ! -f "$APP_DIR/.env" ]; then
            echo "ðŸ“ Creating .env file..."
            sudo cp "$APP_DIR/.env.example" "$APP_DIR/.env"
            sudo chown www-data:www-data "$APP_DIR/.env"
            
            # Generate app key
            cd "$APP_DIR"
            sudo -u www-data php artisan key:generate --force
          fi
          
          # Update .env with secrets
          sudo sed -i "s/^APP_NAME=.*/APP_NAME=\"${{ env.APP_NAME }}\"/" "$APP_DIR/.env"
          sudo sed -i "s/^APP_ENV=.*/APP_ENV=production/" "$APP_DIR/.env"
          sudo sed -i "s/^APP_DEBUG=.*/APP_DEBUG=false/" "$APP_DIR/.env"
          sudo sed -i "s/^DB_HOST=.*/DB_HOST=\"${{ secrets.DB_HOST }}\"/" "$APP_DIR/.env"
          sudo sed -i "s/^DB_DATABASE=.*/DB_DATABASE=\"lms_marketplace\"/" "$APP_DIR/.env"
          sudo sed -i "s/^DB_USERNAME=.*/DB_USERNAME=\"${{ secrets.DB_USERNAME }}\"/" "$APP_DIR/.env"
          sudo sed -i "s/^DB_PASSWORD=.*/DB_PASSWORD=\"${{ secrets.DB_PASSWORD }}\"/" "$APP_DIR/.env"
          
          # Laravel optimization
          echo "âš™ï¸  Optimizing Laravel..."
          cd "$APP_DIR"
          sudo -u www-data php artisan config:cache
          sudo -u www-data php artisan route:cache
          sudo -u www-data php artisan view:cache
          
          # Run migrations
          echo "ðŸ—„ï¸  Running migrations..."
          sudo -u www-data php artisan migrate --force || echo "Migration warnings (check if expected)"
          
          # Create/Update Nginx configuration
          echo "ðŸŒ Configuring Nginx..."
          sudo tee /etc/nginx/sites-available/${{ env.APP_NAME }} > /dev/null <<EOF
          server {
              listen 80;
              server_name ${{ env.APP_NAME }}.com www.${{ env.APP_NAME }}.com;
              root $APP_DIR/public;
              
              index index.php index.html;
              
              location / {
                  try_files \$uri \$uri/ /index.php?\$query_string;
              }
              
              location ~ \.php$ {
                  fastcgi_pass unix:/var/run/php/php8.2-fpm.sock;
                  fastcgi_index index.php;
                  fastcgi_param SCRIPT_FILENAME \$realpath_root\$fastcgi_script_name;
                  include fastcgi_params;
              }
              
              location ~ /\.(?!well-known).* {
                  deny all;
              }
          }
          EOF
          
          # Enable site
          sudo ln -sf /etc/nginx/sites-available/${{ env.APP_NAME }} /etc/nginx/sites-enabled/
          
          # Test and reload Nginx
          sudo nginx -t && sudo systemctl reload nginx
          
          echo "âœ… Deployment complete!"
          echo "ðŸŒ Application: ${{ env.APP_NAME }}"
          echo "ðŸ“ Directory: $APP_DIR"
          
          # Cleanup
          rm -f /tmp/deployment.tar.gz
